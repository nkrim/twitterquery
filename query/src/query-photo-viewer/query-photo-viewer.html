<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../bower_components/neon-animation/animations/slide-left-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/slide-from-left-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/slide-right-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/slide-from-right-animation.html">

<link rel="import" href="../../bower_components/paper-styles/typography.html">

<link rel="import" href="../query-photo/query-photo.html">

<dom-module id="query-photo-viewer">
	<template>
		<style>
			:host {
				display: block;
				overflow: hidden;
				/*border: solid 1px rgba(0,0,0,0.1);*/
				border-radius: 8px;
				position: relative;
			}
			:host([empty]) {
				display: none;
			}

			.controller {
				@apply(--layout-horizontal);
				@apply(--layout-center);
				width: 20%;
				position: absolute;
				top: 0;
				bottom: 0;
				cursor: pointer;
			}
			.controller[disabled] {
				display: none;
			}
			.controller iron-icon {
				color: rgba(255,255,255,0.3);
				--iron-icon-height: 64px;
				--iron-icon-width: 64px;
				--iron-icon-stroke-color: rgba(0,0,0,0.1);
				-webkit-transition: color 0.2s linear;
				-moz-transition: color 0.2s linear;
				-o-transition: color 0.2s linear;
				transition: color 0.2s linear;
			}
			.controller:hover iron-icon {
				color: rgba(255,255,255,1);
			}

			#leftController {
				@apply(--layout-start-justified);
				left: 0;
			}
			#rightController {
				@apply(--layout-end-justified);
				right: 0;
			}

			#countDropdown {
				@apply(--paper-font-body2);
				@apply(--layout-horizontal);
				@apply(--layout-center-center);
				height: 48px;
				width: 64px;
				background-color: rgba(0,0,0,0.4);
				color: #fff;
				position: absolute;
				left: 0;
				top: -64px;
				-webkit-transition: top 0.2s ease-in-out;
				-moz-transition: top 0.2s ease-in-out;
				-o-transition: top 0.2s ease-in-out;
				transition: top 0.2s ease-in-out;
			}
			:host(:hover) #countDropdown {
				top: 0;
			}
			#countDropdown[hidden] {
				display: none;
			}
			#countDropdown span {
				margin: 0 2px;
			}
		</style>

		<neon-animated-pages 	id="pages" style$="[[_computePagesStyle(photos)]]"  fallback-selection="0"
								selected="{{selected}}" selected-attribute="active" selectable="query-photo"
								entry-animation="[[_computeEntryAnimtion(_right)]]" exit-animation="[[_computeExitAnimtion(_right)]]">
		    <template is="dom-repeat" items="[[photos]]">
		    	<query-photo 	photo-url="[[item.photo_url]]" 
		    					link-url="[[item.expanded_url]]" 
		    					height="[[item.height]]"
		    					width="[[item.width]]"
		    					sizing="cover">
		    				</query-photo>
		    </template>
		</neon-animated-pages>
		<div id="leftController" class="controller">
			<iron-icon icon="chevron-left"></iron-icon>
		</div>
		<div id="rightController" class="controller">
			<iron-icon icon="chevron-right"></iron-icon>
		</div>
		<div id="countDropdown" hidden$="[[_computeCountHidden(photos)]]">
			<span>[[_getIndex()]]</span>
			<span>/</span>
			<span>[[_computeCount(photos)]]</span>
		</div>
		
	</template>
	<script>
		Polymer({
			is: 'query-photo-viewer',

			properties: {
				photos: {
					type: Array,
					value: function() { return []; },
				},

				selected: {
					type: String,
					value: '',
					notify: true,
				},

				empty: {
					type: Boolean,
					value: false,
					readOnly: true,
					computed: '_computeEmpty(photos)',
					reflectToAttribute: true,
				},

				/**
				 * Private properties
				 */
				_right: {
					type: Boolean,
					value: false,
					readOnly: true,
				},
			},

			observers: [
				'_setControllerUsability(photos, selected)',
			],

			/**
			 * Private functions
			 */
			_getIndex: function() {
				var pages = this.$.pages;
				var item = pages.selectedItem;
				if(item)
					return pages.indexOf(item);
				return -1;
			},

			/**
			 * Property observers
			 */
			_setControllerUsability: function(photos, selected) {
				var leftDisabled = true;
				var rightDisabled = true;
				var index = this._getIndex();
				if(index >= 0 && photos && photos.length > 0) {
					var index = this.$.indexOf(item);
					if(index > 0)
						leftDisabled = false;
					if(index < photos.length-1)
						rightDisabled = false;
				}
				this.toggleAttribute('disabled', leftDisabled, this.$.leftController);
				this.toggleAttribute('disabled', rightDisabled, this.$.rightController);
			},

			/**
			 * Computed functions
			 */
			_computeEmpty: function(photos) {
				return !photos || photos.length == 0;
			},

			_computePagesStyle: function(photos) {
				var maxHeight = 0;
				photos.forEach(function(p) {
					if(p.height)
						maxHeight = Math.max(maxHeight, p.height);
				});
				var height = Math.min(maxHeight, 360)
				return "height: "+height+"px;";
			},

			_computeEntryAnimtion: function(right) {
				return right ? 'slide-from-right-animation' : 'slide-from-left-animation';
			},

			_computeExitAnimtion: function(right) {
				return right ? 'slide-left-animation' : 'slide-right-animation';
			},

			_computeCountHidden: function(photos) {
				return !photos || photos.length <= 1;
			},

			_computeCount: function(photos) {
				if(photos)
					return photos.length;
				return '';
			},
		});
	</script>
</dom-module>