<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-overlay-behavior/iron-overlay-behavior.html">

<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../bower_components/neon-animation/animations/slide-left-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/slide-from-left-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/slide-right-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/slide-from-right-animation.html">

<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="query-photo-overlay">
	<template>
		<style>
			:host {
				display: block;
				position: relative;
				height: 80vh;
				width: 80vw;
			}

			#pages: {
				position: relative;
				background-color: #000;
			}

			.controller {
				@apply(--layout-horizontal);
				@apply(--layout-center);
				width: 64px;
				position: absolute;
				top: 0;
				bottom: 0;
				cursor: pointer;
				opacity: 1;
				visibility: visible;
				-webkit-transition: opacity 0.2s linear, visibility 0s linear 0s;
				-moz-transition: opacity 0.2s linear, visibility 0s linear 0s;
				-o-transition: opacity 0.2s linear, visibility 0s linear 0s;
				transition: opacity 0.2s linear, visibility 0s linear 0s;
			}
			.controller[disabled] {
				opacity: 0;
				visibility: hidden;
				-webkit-transition: opacity 0.2s linear, visibility 0s linear 0.2s;
				-moz-transition: opacity 0.2s linear, visibility 0s linear 0.2s;
				-o-transition: opacity 0.2s linear, visibility 0s linear 0.2s;
				transition: opacity 0.2s linear, visibility 0s linear 0.2s;
			}
			.controller iron-icon {
				color: rgba(255,255,255,0.3);
				--iron-icon-height: 64px;
				--iron-icon-width: 64px;
				--iron-icon-stroke-color: rgba(0,0,0,0.1);
				-webkit-transition: color 0.2s linear;
				-moz-transition: color 0.2s linear;
				-o-transition: color 0.2s linear;
				transition: color 0.2s linear;
			}
			.controller:hover iron-icon {
				color: rgba(255,255,255,1);
			}

			#leftController {
				@apply(--layout-start-justified);
				left: -64px;
			}
			#rightController {
				@apply(--layout-end-justified);
				right: -64px;
			}

			#countDropdown {
				@apply(--paper-font-title);
				@apply(--layout-horizontal);
				@apply(--layout-center-center);
				height: 48px;
				background-color: rgba(0,0,0,0.5);
				color: #fff;
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				pointer-events: none;
			}
			#countDropdown[hidden] {
				display: none;
			}
			#countDropdown span {
				margin: 0 1px;
			}
			#countDropdown span.count-number {
				@apply(--layout-flex);
			}
			#countDropdown span.count-index {
				text-align: right;
			}
		</style>
		
		<neon-animated-pages 	id="pages" style$="[[_computePagesStyle(_maxHeight, _maxWidth)]]"  fallback-selection="0"
								selected="{{selected}}" selected-attribute="active" selectable="query-photo" selected-item="{{selectedItem}}"
								entry-animation="[[_computeEntryAnimtion(_right)]]" exit-animation="[[_computeExitAnimtion(_right)]]">
		    <template is="dom-repeat" items="[[photos]]">
		    	<query-photo 	photo-url="[[item.photo_url]]" 
		    					link-url="[[item.expanded_url]]" 
		    					sizing="fill"
		    					height="[[item.height]]"
		    					width="[[item.width]]"
		    					max-height="[[_maxHeight]]"
		    					max-width="[[_maxWidth]]">
		    				</query-photo>
		    </template>
		    <div id="leftController" class="controller">
				<iron-icon icon="chevron-left"></iron-icon>
			</div>
			<div id="rightController" class="controller">
				<iron-icon icon="chevron-right"></iron-icon>
			</div>
			<div id="countDropdown" hidden$="[[_computeCountHidden(photos)]]">
				<span class="count-number count-index">[[_computeCountIndex(selectedItem)]]</span>
				<span>/</span>
				<span class="count-number count-total">[[_computeCountTotal(photos)]]</span>
			</div>
		</neon-animated-pages>
	</template>
	<script>
		Polymer({
			is: 'query-photo-overlay',

			behaviors: [Polymer.IronOverlayBehavior],

			properties: {
				photos: {
					type: Array,
					value: function() { return []; },
				},

				selected: {
					type: String,
					value: '',
					notify: true,
				},

				/**
				 * Private properties
				 */
				_right: {
					type: Boolean,
					value: false,
					readOnly: true,
				},

				_maxHeight: {
					type: Number,
					value: null,
				},

				_maxWidth: {
					type: Number,
					value: null,
				},
			},

			listeners: {
				'pages.iron-select': '_handlePagesSelect',
				'pages.iron-items-changed': '_handlePagesItemsChanged',
				'leftController.tap': '_handleLeftControllerTap',
				'rightController.tap': '_handleRightControllerTap',
			},

			ready: function() {
				// Set inherited values
				this.withBackdrop = true;
			},

			/**
			 * Private functions
			 */
			_getIndex: function() {
				var pages = this.$.pages;
				var item = pages.selectedItem;
				if(item)
					return pages.indexOf(item);
				return -1;
			},

			_getIndexOf: function(item) {
				return this.$.pages.indexOf(item);
			},

			_setControllerUsability: function(items) {
				if(!items)
					items = this.$.pages.items;
				var leftDisabled = true;
				var rightDisabled = true;
				var index = this._getIndex();
				var length = items.length;
				if(index >= 0 && length > 0) {
					if(index > 0)
						leftDisabled = false;
					if(index < length-1)
						rightDisabled = false;
				}
				this.toggleAttribute('disabled', leftDisabled, this.$.leftController);
				this.toggleAttribute('disabled', rightDisabled, this.$.rightController);
			},

			_setMaxHeightWidth: function(items) {
				if(!items)
					items = this.$.pages.items;
				var height = this.offsetHeight;
				var width = this.offsetWidth;
				var maxHeight = null;
				var maxWidth = null;
				items.forEach(function(p) {
					if(p.height && p.width) {
						if(p.height >= height && p.width >= width) {
							var heightRatio = height/p.height;
							var widthRatio = width/p.width;
							if(heightRatio <= widthRatio) {
								maxHeight = height;
								maxWidth = Math.max(maxWidth, width*heightRatio);
							}
							else {
								maxHeight = Math.max(maxHeight, height*widthRatio);
								maxWidth = width;
							}
						}
						else if(p.height >= height) {
							maxHeight = height;
							maxWidth = Math.max(maxWidth, p.width*height/p.height);
						}
						else if(p.width >= width) {
							maxHeight = Math.max(maxHeight, p.height*width/p.width);
							maxWidth = width;
						}
						else {
							maxHeight = Math.max(maxHeight, p.height);
							maxWidth = Math.max(maxWidth, p.width)
						}
					}
				});
				this._maxHeight = maxHeight || null;
				this._maxWidth = maxWidth || null;
			},

			/**
			 * Event listeners
			 */
			_handlePagesSelect: function() {
				this._setControllerUsability();
			},

			_handlePagesItemsChanged: function() {
				this._setControllerUsability();
			},

			_handleLeftControllerTap: function() {
				this._set_right(false);
				this.$.pages.selectPrevious();
			},

			_handleRightControllerTap: function() {
				this._set_right(true);
				this.$.pages.selectNext();
			},

			/**
			 * Computed functions
			 */
			_computeEmpty: function(photos) {
				return !photos || photos.length == 0;
			},

			_computePagesStyle: function(maxHeight, maxWidth) {
				var style = '';
				if(maxHeight)
					style += 'height:'+maxHeight+'px;';
				if(maxWidth)
					style += 'width:'+maxWidth+'px;';
				return style;
			},

			_computeEntryAnimtion: function(right) {
				return right ? 'slide-from-right-animation' : 'slide-from-left-animation';
			},

			_computeExitAnimtion: function(right) {
				return right ? 'slide-left-animation' : 'slide-right-animation';
			},

			_computeCountHidden: function(photos) {
				return !photos || photos.length <= 1;
			},

			_computeCountIndex: function(item) {
				return this._getIndexOf(item)+1;
			},

			_computeCountTotal: function(photos) {
				if(photos)
					return photos.length;
				return '';
			},
		});
	</script>
</dom-module>