<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="query-ajax">
	<template>
		<iron-ajax
			id="ajax"
			url="/query"
			params="[[_computeParams(query,limit)]]"
			handle-as="json"
			loading="{{loading}}"
			>
		</iron-ajax>
	</template>
	<script>
		Polymer({
			is: 'query-ajax',

			properties: {
				query: {
					type: String,
					value: '',
				},

				limit: {
					type: Number,
					value: 0,
				},

				data: {
					type: Object,
					value: null,
					readOnly: true,
					notifies: true,
				},

				error: {
					type: Boolean,
					value: false,
					readOnly: true,
					notifies: true,
				},

				loading: {
					type: Boolean,
					value: false,
					notifies: true,
				},
			},

			listeners: {
				'ajax.last-response-changed': '_handleAjaxResponse',
			},

			/**
			 * Public functions
			 */
			makeQuery: function() {
				if(query.trim().length == 0)
					this._setData({'message': 'Please enter a search query.'});
				else
					this.$.ajax.generateRequest();
			},

			/**
			 * Compute functions
			 */
			_computeParams: function(query, limit) {
				var params = {};

				if(query !== null && query !== '')
					params['q'] = query;
				
				if(limit > 0)
					params['limit'] = limit;

				return params;
			},

			/**
			 * Event handlers
			 */
			_handleAjaxResponse: function(e) {
				var response = e.detail.value;
				var data_cur = null;
				if('success' in response) {
					if(response.success && 'results' in response) {
						data_cur = {'data': response.results};
						success = true;
					}
					else if ('error' in response && 'code' in response) {
						if(response.code == 4 && 'wait' in response) {
							data_cur = {'error': 'Server has recieved too many requests, try again in '+response.wait+' seconds.'};
						}
						else {
							data_cur = {'error': response.error};
						}
					}
					else {
						data_cur = {'error': 'Unknown error in retrieving data.'};
					}
				}
				else {
					data_cur = {'error': 'Unknown error in retrieving data.'};
				}
				data_cur.success = !('data' in data_cur);
				this._setError(data_cur.success);
				this._setData(data_cur);
			},
		});
	</script>
</dom-module>