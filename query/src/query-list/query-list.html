<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../bower_components/paper-styles/typography.html">

<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">

<link rel="import" href="../query-block/query-block.html">

<dom-module id="query-list">
	<template>
		<style>
			:host {
				display: block;
				position: relative;
				opacity: 1;
				visibility: visible;
			}

			#main {
				width: 100%;
				overflow: hidden;
			}

			#pages neon-animatable {
				display: block;
			}
			.result-container {
				@apply(--paper-font-headline);
				display: block;
				background-color: #fff;
				border-radius: 10px;
				word-wrap: break-word;
				box-sizing: border-box;
			}

			#dataContainer {
				
			}
			#dataContainer query-block:not(:last-of-type) {
				border-bottom: solid 1px rgba(0,0,0,0.3);
			}

			#messageContainer {
				padding: 24px;
			}

			#errorContainer {
				padding: 24px;
			}

			.optional-message-container:not([empty]) {
				padding: 24px;
			}
		</style>

		<div id="main" style="height: [[_height]]px">
			<neon-animated-pages id="pages" selected="[[_state]]" entry-animation="fade-in-animation" exit-animation="fade-out-animation">
		    	<div>
		    		<div id="emptyContainer" class="result-container"></div>
		    	</div>
		    	<div>
		    		<div id="messageContainer" class="result-container">[[message]]</div>
		    	</div>
		    	<div>
		    		<div id="dataContainer" class="result-container">
			    		<div class="optional-message-container" empty$="[[_isEmptyString(message)]]">[[message]]</div>
			    		<template id="list" is="dom-repeat" items="[[_computeStatuses(data)]]">
			    			<query-block status="[[item]]"></query-block>
			    		</template>
			    	</div>
			    </div>
		    	<div>
		    		<div id="errorContainer" class="result-container"><b>Error:</b> [[error]]</div>
		    	</div>
			</neon-animated-pages>
		</div>
		
	</template>
	<script>
		Polymer({
			is: 'query-list',

			properties: {
				data: {
					type: Object,
					value: null,
					observer: '_dataChanged',
				},

				message: {
					type: String,
					value: '',
					observer: '_messageChanged',
				},

				error: {
					type: String,
					value: '',
					observer: '_errorChanged',
				},

				/**
				 * Private properties
				 */
				_height: {
					type: Number,
					value: 0,
				},

				_state: {
					type: Number,
					value: 0, // 0=empty; 1=data; 2=error
					readOnly: true,
					observer: '_stateChanged',
				}
			},

			ready: function() {
				this.listen(Polymer.dom(document.body).querySelector('#app'), 'scroll-finished', '_handleScrollFinished')
			},

			/**
			 * Public functions
			 */
			clear: function() {
				this._set_state(0);
				this.data = null;
				this.message = '';
				this.error = '';
			},

			resetHeight: function(state=null, scroll=false, scrollCompensate=false) {
				var container;
				var scrollTo = -1;
				switch(state!==null ? state : this._state) {
					case 0:
						container = this.$.emptyContainer;
						scrollTo = 0;
						break;
					case 1:
						container = this.$.messageContainer;
						scrollTo = 0;
						break;
					case 2:
						this.$.list.render();
						container = this.$.dataContainer;
						scrollTo = 192;
						break;
					case 3:
						container = this.$.errorContainer;
						scrollTo = 192;

						break;
				}
				this._setHeight(container, scroll?scrollTo:-2, scrollCompensate||(scrollTo!==0));
			},

			/**
			 * Private functions
			 */
			_setHeight(container, scrollTo=-1, scrollCompensate=false) {
				if(!container)
					return;
				container.style.visibility = 'hidden';
				container.style.position = 'absolute';
				var height = container.offsetHeight;
				if(scrollCompensate)
					height = Math.max(height, window.pageYOffset+window.innerHeight-192);
				this._height = height;
				container.style.position = '';
				container.style.visibility = '';
				if(scrollTo >= 0)
					Polymer.dom(document.body).querySelector('#app').scroll(scrollTo);
			},

			_isEmptyString: function(str) {
				return str === '';
			},

			_computeMainEmpty: function(state) {
				return state == 0;
			},

			/**
			 * Property observers
			 */
			_messageChanged: function(message) {
				if(!message) {
					if(this._state === 1)
						this._set_state(0);
				}
				else
					this._set_state(1);
			},

			_dataChanged: function(data) {
				if(!data) {
					if(this._state === 2)
						this._set_state(this.message ? 1 : 0);
				}
				else
					this._set_state(2);
			},

			_errorChanged: function(error) {
				if(!error) {
					if(this._state === 3)
						this._set_state(0);
				}
				else
					this._set_state(3);
			},

			_stateChanged: function(state) {
				this.resetHeight(state, true, true);
			},

			_computeMessage: function(data) {
				if(data !== null && 'message' in data)
					return data.message;
				return '';
			},

			_computeStatuses: function(data) {
				if(data !== null && 'statuses' in data)
					return data.statuses;
				return [];
			},

			/**
			 * Event handlers
			 */
			_handleScrollFinished: function() {
				this.resetHeight();
			},
		});
	</script>
</dom-module>