<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../bower_components/paper-styles/typography.html">

<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">

<link rel="import" href="../query-block/query-block.html">

<dom-module id="query-list">
	<template>
		<style>
			:host {
				display: block;
				position: relative;
			}

			#main {
				width: 100%;
				background-color: #fff;
				border-radius: 10px;
				overflow: hidden;
				-webkit-transition: height 0.2s ease-in-out;
				-moz-transition: height 0.2s ease-in-out;
				-o-transition: height 0.2s ease-in-out;
				transition: height 0.2s ease-in-out;
			} 

			#pages neon-animatable {
				display: block;
			}
			.result-container {
				display: block;
				word-wrap: break-word;
				box-sizing: border-box;
			}

			#dataContainer {
				@apply(--paper-font-headline);
			}
			#dataContainer query-block:not(:last-of-type) {
				border-bottom: solid 1px rgba(0,0,0,0.3);
			}

			#messageContainer:not([empty]) {
				padding: 24px;
			}

			#errorContainer {
				@apply(--paper-font-headline);
			}
		</style>

		<div id="main" style="height: [[_height]]px">
			<neon-animated-pages id="pages" selected="[[_state]]" entry-animation="fade-in-animation" exit-animation="fade-out-animation">
			    <neon-animatable>
			    	<div id="emptyContainer" class="result-container"></div>
			    </neon-animatable>
			    <neon-animatable>
			    	<div id="dataContainer" class="result-container">
			    		<div id="messageContainer" empty$="[[_isEmptyString(message)]]">[[message]]</div>
			    		<template id="list" is="dom-repeat" items="[[_computeStatuses(data)]]">
			    			<query-block status="[[item]]"></query-block>
			    		</template>
			    	</div>
			    </neon-animatable>
			    <neon-animatable>
			    	<div id="errorContainer" class="result-container"><b>Error:</b> [[error]]</div>
			    </neon-animatable>
			</neon-animated-pages>
		</div>
		
	</template>
	<script>
		Polymer({
			is: 'query-list',

			properties: {
				data: {
					type: Object,
					value: null,
					observer: '_dataChanged',
				},

				message: {
					type: String,
					value: '',
				},

				error: {
					type: String,
					value: '',
					observer: '_errorChanged',
				},

				/**
				 * Private properties
				 */
				_height: {
					type: Number,
					value: 0,
				},

				_state: {
					type: Number,
					value: 0, // 0=empty; 1=data; 2=error
					readOnly: true,
					observer: '_stateChanged',
				}
			},

			/**
			 * Public functions
			 */
			clear: function() {
				this._set_state(0);
				this.data = null;
				this.error = '';
			},

			/**
			 * Private functions
			 */
			_setHeight(container) {
				container.style.visibility = 'hidden';
				container.style.position = 'absolute';
				this._height = container.offsetHeight;
				container.style.position = '';
				container.style.visibility = '';
				Polymer.dom(document.body).querySelector('#app').scroll(192);
			},

			_isEmptyString: function(str) {
				return str === '';
			},

			/**
			 * Property observers
			 */
			_dataChanged: function(data) {
				if(data === null) {
					if(this._state === 1)
						this._set_state(0);
				}
				else
					this._set_state(1);
			},

			_errorChanged: function(error) {
				if(error === '') {
					if(this._state === 2)
						this._set_state(0);
				}
				else
					this._set_state(2);
			},

			_stateChanged: function(state) {
				var container;
				switch(state) {
					case 0:
						this._height = 0;
						return;
					case 1:
						this.$.list.render();
						this._setHeight(this.$.dataContainer);
						break;
					case 2:
						this._setHeight(this.$.errorContainer);
						break;
				}
			},

			_computeMessage: function(data) {
				if(data !== null && 'message' in data)
					return data.message;
				return '';
			},

			_computeStatuses: function(data) {
				if(data !== null && 'statuses' in data)
					return data.statuses;
				return [];
			},
		});
	</script>
</dom-module>