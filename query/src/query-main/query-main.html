<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">

<link rel="import" href="../query-ajax/query-ajax.html">
<link rel="import" href="../query-list/query-list.html">

<dom-module id="query-main">
	<template>
		<style>
			:host {
				display: block;
				position: relative;
			}

			.loading-spinner {
				position: absolute;
				top: -48px;
				left: 0;
				right: 0;
				margin: auto;
				--paper-spinner-color: #fff;
			}
		</style>
		
		<query-ajax
			id="ajax" auto
			query="[[query]]"
			limit="[[limit]]"
			loading="{{loading}}">
		</query-ajax>

		<paper-spinner-lite active="[[loading]]" class="loading-spinner"></paper-spinner-lite>
		<query-list id="list"></query-list>

	</template>
	<script>
		Polymer({
			is: 'query-main',

			properties: {
				query: {
					type: String,
					value: '',
				},

				limit: {
					type: Number,
					value: 0,
				},

				success: {
					type: Boolean,
					value: false,
					notify: true,
					readOnly: true,
				},

				searchId: {
					type: String,
					value: '',
					notify: true,
					readOnly: true,
				},
			},

			listeners: {
				'ajax.data-changed': '_handleDataChanged',
			},

			/**
			 * Public functions
			 */
			makeQuery: function() {
				this.$.list.clear();
				this.$.ajax.makeQuery();
			},

			/**
			 * Event handlers
			 */
			_handleDataChanged: function(e) {
				var results = e.detail.value;
				if(results === null)
					return;
				if(!this.$.ajax.error) {
					this.$.list.error = '';
					this.$.list.message = results.message || '';
					this.$.list.data = results.data || {};
					this._setSuccess(true);
					this._setSearchId(results.data.id);
				}
				else {
					this.$.list.data = null;
					this.$.list.message = '';
					this.$.list.error = results.error || 'Error';
					this._setSuccess(false);
					this._setSearchId('');
					console.log(results.error);
				}
			},
		});
	</script>
</dom-module>